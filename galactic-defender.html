<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
<title>Galactic Defender</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  :root{
    --ink:#fff; --accent:#ffa500; --accent2:#ffff66; --ok:#25d366; --danger:#ff4d4d;
    --pad:12px;
  }

  /* Reset y anti callout iOS */
  *{
    margin:0; padding:0; box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
    -webkit-user-select:none; user-select:none;
    -webkit-touch-callout:none; touch-action:manipulation;
  }

  html, body{background:#000; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto;}

  body{
    /* ahora la página es scrolleable naturalmente */
    min-height:100dvh;
    background:linear-gradient(180deg,#0c0032,#190061,#240090);
    padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
  }

  .page{
    width:min(980px, 100%);
    margin-inline:auto;
    padding: clamp(10px, 2.8vw, 18px);
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  /* Topbar */
  .topbar{
    position:sticky; top:0; z-index:10;
    padding:8px max(10px, env(safe-area-inset-left));
    padding-right:max(10px, env(safe-area-inset-right));
    background:linear-gradient(180deg,rgba(0,0,0,.86),rgba(0,0,0,.45));
    backdrop-filter:saturate(1.2) blur(8px);
    border-bottom:1px solid rgba(255,165,0,.25);
    display:flex; align-items:center; gap:10px;
  }
  .back{
    appearance:none; border:1px solid var(--accent); color:#000;
    background:linear-gradient(135deg,#ffd04a,#ff9f1c);
    border-radius:12px; padding:10px 12px; font-weight:800; display:flex; gap:8px; align-items:center;
  }
  .spacer{flex:1}

  .header{ text-align:center; padding-top:2px }
  h1{
    font-size: clamp(1.4rem, 4.5vw, 2rem);
    background:linear-gradient(45deg,#ff6b6b,#ffa500,#ffff00);
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    text-shadow:0 0 18px var(--accent); letter-spacing:2px;
  }
  .subtitle{font-size:.95rem; color:var(--accent)}

  /* HUD */
  .stats{
    display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    background:rgba(0,0,0,.72);
    border:1px solid var(--accent); border-radius:12px; padding:8px 10px;
  }
  .stat{display:flex; flex-direction:column; align-items:center}
  .stat-label{font-size:.78rem; color:var(--accent)}
  .stat-value{font-weight:800; color:#ffff00; font-size:1rem}

  .boss-health{width:100%; height:10px; background:#333; border-radius:6px; overflow:hidden; display:none}
  .boss-health-bar{height:100%; background:linear-gradient(90deg,#ff0000,#ffff00); width:100%; transition:width .25s}

  /* Power bar con contadores */
  .powerbar{
    display:flex; gap:10px; align-items:center; justify-content:center;
  }
  .pp{
    min-width:56px; height:42px; padding:0 10px;
    display:flex; align-items:center; justify-content:center; gap:8px;
    border-radius:12px; border:1px solid var(--accent);
    background:rgba(255,165,0,.14); font-weight:800;
  }
  .pp .cnt{color:#ffff00}

  /* Game Area: ahora usa aspect-ratio (alto fijo máximo para que el resto quede visible y se pueda scrollear) */
  .game-card{
    border:2px solid var(--accent); border-radius:14px; overflow:hidden;
    box-shadow:0 0 20px rgba(255,165,0,.3); background:#000;
  }
  .game-area{
    position:relative; width:100%;
    aspect-ratio: 9 / 13;          /* vertical y cómodo */
    max-height: 70dvh;             /* deja sitio a controles => permite scroll si no cabe */
  }
  canvas{display:block; width:100%; height:100%}

  .game-over{position:absolute; inset:0; display:none; place-items:center}
  .dialog{
    background:rgba(0,0,0,.95); border:3px solid var(--accent); border-radius:14px;
    width:min(92%,320px); padding:18px; text-align:center; box-shadow:0 0 30px rgba(255,165,0,.5)
  }
  .dialog h2{color:var(--accent); margin-bottom:12px}
  .final-score{color:#ffff00; margin:10px 0 16px}

  .btn{
    appearance:none; border:none; border-radius:12px;
    background:linear-gradient(135deg,#ffd04a,#ff9f1c);
    color:#000; font-weight:800; padding:12px 14px; display:inline-flex; align-items:center; gap:8px; justify-content:center;
  }
  .btn:active{transform:scale(.98)}
  .btn-alt{background:linear-gradient(135deg,#ffff66,#ffaa00)}
  .btn:disabled{opacity:.55; filter:grayscale(1)}

  /* Controles táctiles */
  .controls{
    display:grid; grid-template-columns:1fr auto; gap:14px; align-items:center;
    margin-top:8px;
  }
  .movement{
    display:grid; gap:8px; justify-self:start;
  }
  .row{display:flex; gap:8px; justify-content:center}
  .move-btn{
    width:64px; height:64px; border-radius:14px; border:2px solid var(--accent);
    background:rgba(255,165,0,.28); color:var(--accent); display:grid; place-items:center; font-size:1.25rem
  }
  .move-btn:active{background:rgba(255,165,0,.72); color:#000}

  .actions{display:grid; gap:12px; justify-items:end}
  .action-btn{
    width:80px; height:80px; border-radius:999px; border:2px solid #ff6666;
    background:radial-gradient(circle,#ff4444,#cc0000); color:#fff; display:grid; place-items:center; font-size:1.45rem; box-shadow:0 0 18px rgba(255,0,0,.45)
  }
  .special-btn{border-color:var(--ok); background:radial-gradient(circle,var(--ok),#128c4a)}
  .special-btn:disabled{opacity:.6; box-shadow:none; filter:grayscale(1)}

  .game-buttons{display:flex; gap:10px; margin-top:6px; justify-content:center}

  /* Fondo estrellas (suave) */
  .stars{position:fixed; inset:auto 0 0 0; height:300px; pointer-events:none; z-index:-1; opacity:.55}
  .star{position:absolute; background:#fff; border-radius:50%; animation:twinkle 3s infinite}
  @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}

  /* Responsive */
  @media (max-width:420px){
    .move-btn{width:58px; height:58px}
    .action-btn{width:76px; height:76px}
  }
</style>
</head>
<body>
  <!-- estrellas solo en la parte baja para no tapar la cabecera -->
  <div class="stars" id="stars"></div>

  <div class="topbar">
    <button class="back" onclick="location.href='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver al Arcade</button>
    <div class="spacer"></div>
  </div>

  <main class="page">
    <section class="header">
      <h1>GALACTIC DEFENDER</h1>
      <p class="subtitle">Inspirado en el clásico Galaga</p>
    </section>

    <section class="stats">
      <div class="stat"><div class="stat-label">PUNTUACIÓN</div><div class="stat-value" id="score">0</div></div>
      <div class="stat"><div class="stat-label">VIDAS</div><div class="stat-value" id="lives">3</div></div>
      <div class="stat"><div class="stat-label">NIVEL</div><div class="stat-value" id="level">1</div></div>
      <div class="stat"><div class="stat-label">RÉCORD</div><div class="stat-value" id="highScore">0</div></div>
    </section>

    <div class="boss-health" id="bossHealth"><div class="boss-health-bar" id="bossHealthBar"></div></div>

    <section class="powerbar">
      <div class="pp" title="Doble Disparo"><i class="fa-solid fa-gun"></i><span class="cnt" id="ppDouble">0</span></div>
      <div class="pp" title="Escudo"><i class="fa-solid fa-shield-halved"></i><span class="cnt" id="ppShield">0</span></div>
      <div class="pp" title="Bombas"><i class="fa-solid fa-bomb"></i><span class="cnt" id="ppBomb">0</span></div>
    </section>

    <section class="game-card">
      <div class="game-area" id="gameArea">
        <canvas id="gameCanvas"></canvas>

        <div class="game-over" id="gameOver">
          <div class="dialog">
            <h2>¡GAME OVER!</h2>
            <div class="final-score" id="finalScore">Puntuación: 0</div>
            <button class="btn" id="restartButton"><i class="fa-solid fa-rotate-right"></i> Jugar de nuevo</button>
          </div>
        </div>
      </div>
    </section>

    <section class="controls">
      <div class="movement">
        <div class="row">
          <button class="move-btn" id="moveLeft"><i class="fa-solid fa-arrow-left"></i></button>
          <button class="move-btn" id="moveUp"><i class="fa-solid fa-arrow-up"></i></button>
          <button class="move-btn" id="moveRight"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
        <div class="row">
          <span class="move-btn" style="visibility:hidden"></span>
          <button class="move-btn" id="moveDown"><i class="fa-solid fa-arrow-down"></i></button>
          <span class="move-btn" style="visibility:hidden"></span>
        </div>
      </div>

      <div class="actions">
        <button class="action-btn" id="fireBtn" aria-label="Disparar"><i class="fa-solid fa-bullseye"></i></button>
        <button class="action-btn special-btn" id="specialBtn" aria-label="Bomba"><i class="fa-solid fa-bomb"></i></button>
      </div>
    </section>

    <section class="game-buttons">
      <button class="btn" id="startButton"><i class="fa-solid fa-play"></i> Iniciar</button>
      <button class="btn btn-alt" id="pauseButton"><i class="fa-solid fa-pause"></i> Pausar</button>
    </section>
  </main>

<script>
/* ===== Estrellas suaves al fondo ===== */
function createStars(){
  const stars = document.getElementById('stars');
  const N = 80;
  for(let i=0;i<N;i++){
    const s = document.createElement('div');
    s.className = 'star';
    const size = 1 + Math.random()*3;
    s.style.width = s.style.height = size+'px';
    s.style.left = (Math.random()*100)+'%';
    s.style.top  = (Math.random()*100)+'%';
    s.style.animationDelay = (Math.random()*3)+'s';
    stars.appendChild(s);
  }
}

/* ===== Canvas con ResizeObserver (mejor en móvil + scroll) ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const dpr = Math.max(1, window.devicePixelRatio || 1);

function sizeCanvasTo(el){
  const r = el.getBoundingClientRect();
  canvas.style.width  = r.width + 'px';
  canvas.style.height = r.height + 'px';
  canvas.width  = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

const gameArea = document.getElementById('gameArea');
const ro = new ResizeObserver(()=>{ sizeCanvasTo(gameArea); draw(); });
ro.observe(gameArea);

/* ===== HUD y estado ===== */
const scoreEl = document.getElementById('score');
const livesEl = document.getElementById('lives');
const levelEl = document.getElementById('level');
const highEl  = document.getElementById('highScore');
const gameOverEl = document.getElementById('gameOver');
const finalScoreEl = document.getElementById('finalScore');
const bossHealth = document.getElementById('bossHealth');
const bossHealthBar = document.getElementById('bossHealthBar');

const ppDouble = document.getElementById('ppDouble');
const ppShield = document.getElementById('ppShield');
const ppBomb   = document.getElementById('ppBomb');
const specialBtn = document.getElementById('specialBtn');

let score=0, lives=3, level=1, highScore = +localStorage.getItem('galagaHighScore') || 0;
let gameRunning=false, gamePaused=false, animId, bossActive=false;

const player = { x:0, y:0, width:34, height:38, speed:7, invulnerable:0,
                 hasShield:false, doubleShot:false, bombs:0 };

let bullets=[], enemyBullets=[];
let enemies=[], bosses=[], formation=[];
let powerUps=[], explosions=[];
let doubleShotTimer=0, shieldTimer=0;

const controls = { left:false, right:false, up:false, down:false };

/* ===== Util ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const AABB=(a,b)=>a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y;
function updateHUD(){
  scoreEl.textContent = score;
  livesEl.textContent = lives;
  levelEl.textContent = level;
  highEl.textContent  = highScore;
  ppDouble.textContent = player.doubleShot ? 'ON' : '0';
  ppShield.textContent = player.hasShield ? Math.ceil(shieldTimer/60) : '0';
  ppBomb.textContent   = player.bombs;
  specialBtn.disabled  = player.bombs<=0 || !gameRunning || gamePaused;
}

/* ===== Formación arriba (guía) ===== */
function createFormation(){
  formation = [];
  const marginX = 36, marginY = 26;
  const areaW = gameArea.clientWidth - marginX*2;

  const maxCols = Math.min(8, Math.floor(areaW / 90));
  const cols = Math.max(5, maxCols);
  const rows = Math.min(4, 3 + Math.min(level-1, 1));

  const spacingX = areaW / cols;
  const spacingY = 64;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      formation.push({
        x: marginX + c*spacingX + spacingX*0.5,
        y: marginY + r*spacingY,
        alive: true,
        type: r===0 ? 'bee' : r===1 ? 'butterfly' : 'galaga'
      });
    }
  }
}

function initGame(){
  player.x = gameArea.clientWidth/2 - player.width/2;
  player.y = gameArea.clientHeight - player.height - 16;
  Object.assign(player,{hasShield:false,doubleShot:false,invulnerable:0,bombs:0});

  bullets=[]; enemyBullets=[]; enemies=[]; bosses=[];
  powerUps=[]; explosions=[]; formation=[]; bossActive=false;

  score=0; lives=3; level=1;
  createFormation(); updateHUD();
  bossHealth.style.display='none';
  document.getElementById('pauseButton').innerHTML = '<i class="fa-solid fa-pause"></i> Pausar';
}

/* ===== Spawner con temporizador + oleada inicial ===== */
let spawnClock=0, spawnEvery=900; // ms
function spawnWave(n=6){
  const alive = formation.filter(e=>e.alive);
  for(let k=0;k<n;k++){
    if(!alive.length) break;
    const pick = alive[(Math.random()*alive.length)|0];
    enemies.push({
      x: pick.x-16, y: -40, width:32, height:32,
      speed: 0.9 + level*0.18,   // lento
      type: pick.type, t:0
    });
  }
}
function maybeSpawn(dt){
  spawnClock += dt;
  if(spawnClock >= spawnEvery){
    spawnClock = 0;
    if(enemies.length < 4 + Math.floor(level*0.7)){
      spawnWave(1 + (Math.random()<0.35)); // 1 ó 2
    }
  }
}

function enemyShoot(){
  if(enemies.length && Math.random()<0.012){
    const e = enemies[(Math.random()*enemies.length)|0];
    enemyBullets.push({x:e.x+e.width/2-2,y:e.y+e.height,width:4,height:12,speed:3.1,color:'#ff6b6b'});
  }
}

function spawnBoss(){
  if(level%3===0 && !bossActive && enemies.length===0){
    bosses.push({
      x: gameArea.clientWidth/2-70, y:-110, width:140, height:86,
      health: 12 + level*2, maxHealth: 12 + level*2, t:0
    });
    bossActive = true; bossHealth.style.display='block'; updateBossHealth();
  }
}
function updateBossHealth(){
  if(!bosses.length) return;
  bossHealthBar.style.width = (bosses[0].health / bosses[0].maxHealth * 100) + '%';
}

/* ===== PowerUps / FX ===== */
function explode(x,y,size=30){ explosions.push({x,y,size,life:1,maxLife:1}); }
function dropPowerUp(x,y){
  if(Math.random()<0.35){
    const bag = ['shield','double','bomb','life'];
    const type = bag[(Math.random()*bag.length)|0];
    powerUps.push({x:x-10,y:y-10,width:22,height:22,speed:2.1,type});
  }
}

/* ===== Game Update / Draw ===== */
let lastTs=0;
function gameLoop(ts){
  if(!gameRunning || gamePaused) return;
  if(!lastTs) lastTs = ts;
  const dt = ts - lastTs; lastTs = ts;

  update(dt);
  draw();
  animId = requestAnimationFrame(gameLoop);
}

function update(dt){
  // mover jugador (mitad inferior)
  if(controls.left)  player.x = clamp(player.x - player.speed, 0, gameArea.clientWidth - player.width);
  if(controls.right) player.x = clamp(player.x + player.speed, 0, gameArea.clientWidth - player.width);
  if(controls.up)    player.y = clamp(player.y - player.speed, gameArea.clientHeight*0.50, gameArea.clientHeight - player.height);
  if(controls.down)  player.y = clamp(player.y + player.speed, gameArea.clientHeight*0.50, gameArea.clientHeight - player.height);

  if(player.doubleShot && --doubleShotTimer<=0) player.doubleShot=false;
  if(player.hasShield  && --shieldTimer<=0)     player.hasShield=false;
  if(player.invulnerable>0) player.invulnerable--;

  maybeSpawn(dt);
  enemyShoot();
  spawnBoss();

  // balas player
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y -= b.speed;
    if(b.y < -b.height) bullets.splice(i,1);
  }

  // balas enemigo
  for(let i=enemyBullets.length-1;i>=0;i--){
    const b=enemyBullets[i]; b.y += b.speed;
    if(b.y > gameArea.clientHeight){ enemyBullets.splice(i,1); continue; }
    if(AABB(b, player) && !player.hasShield && player.invulnerable===0){
      lives--; player.invulnerable = 60; enemyBullets.splice(i,1);
      updateHUD(); explode(player.x+player.width/2, player.y+player.height/2);
      if(lives<=0) gameOver();
    }
  }

  // enemigos
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.t += 0.07;
    e.x += Math.sin(e.t*1.2)*1.5;
    e.y += e.speed;
    if(e.y > gameArea.clientHeight+60){ enemies.splice(i,1); continue; }

    // impacto balas
    for(let j=bullets.length-1;j>=0;j--){
      const p=bullets[j];
      if(AABB({x:p.x,y:p.y,width:p.width,height:p.height}, e)){
        explode(e.x+e.width/2, e.y+e.height/2);
        dropPowerUp(e.x+e.width/2, e.y+e.height/2);
        score += e.type==='bee'?100 : e.type==='butterfly'?150 : 220;
        enemies.splice(i,1); bullets.splice(j,1); updateHUD(); break;
      }
    }
    // choque jugador
    if(AABB(player,e) && !player.hasShield && player.invulnerable===0){
      lives--; player.invulnerable=60; enemies.splice(i,1); updateHUD();
      explode(player.x+player.width/2, player.y+player.height/2);
      if(lives<=0) gameOver();
    }
  }

  // jefe
  for(let i=bosses.length-1;i>=0;i--){
    const b=bosses[i];
    b.t += 0.035;
    b.x = gameArea.clientWidth/2 - b.width/2 + Math.sin(b.t)*120;
    b.y = 50 + Math.cos(b.t*0.6)*26;

    if(Math.random()<0.045){
      for(let k=0;k<3;k++){
        enemyBullets.push({x:b.x+b.width/2-2+(k-1)*22,y:b.y+b.height,width:6,height:15,speed:3.6,color:'#ff00ff'});
      }
    }
    for(let j=bullets.length-1;j>=0;j--){
      const p=bullets[j];
      if(AABB({x:p.x,y:p.y,width:p.width,height:p.height}, b)){
        b.health--; bullets.splice(j,1); updateBossHealth(); explode(p.x,p.y,20);
        if(b.health<=0){
          explode(b.x+b.width/2, b.y+b.height/2, 160);
          score+=1200; bosses.splice(i,1); bossActive=false; bossHealth.style.display='none'; updateHUD();
        }
        break;
      }
    }
  }

  // powerups
  for(let i=powerUps.length-1;i>=0;i--){
    const p=powerUps[i]; p.y += p.speed;
    if(p.y > gameArea.clientHeight){ powerUps.splice(i,1); continue; }
    if(AABB(player,p)){
      if(p.type==='shield'){ player.hasShield=true; shieldTimer=360; }
      else if(p.type==='double'){ player.doubleShot=true; doubleShotTimer=360; }
      else if(p.type==='bomb'){ player.bombs = Math.min(player.bombs+1, 9); }
      else { lives++; }
      powerUps.splice(i,1); updateHUD();
    }
  }

  // explosiones
  for(let i=explosions.length-1;i>=0;i--){
    const e=explosions[i]; e.life -= 0.05; if(e.life<=0) explosions.splice(i,1);
  }

  // pasar de nivel (cuando ya no quede nada)
  if(!formation.some(f=>f.alive) && enemies.length===0 && bosses.length===0){
    level++; createFormation(); updateHUD();
    spawnWave(6); // al subir de nivel también aseguramos acción
  }
}

function drawEnemyShape(e){
  if(e.type==='bee'){ // triángulo rojo
    ctx.fillStyle='#ff5252';
    ctx.beginPath();
    ctx.moveTo(e.x+e.width/2, e.y);
    ctx.lineTo(e.x+e.width, e.y+e.height);
    ctx.lineTo(e.x, e.y+e.height);
    ctx.closePath(); ctx.fill();
  }else if(e.type==='butterfly'){ // rombo verde
    ctx.fillStyle='#45f16f';
    ctx.save(); ctx.translate(e.x+e.width/2, e.y+e.height/2); ctx.rotate(Math.PI/4);
    ctx.fillRect(-e.width/2+2,-e.height/2+2,e.width-4,e.height-4); ctx.restore();
  }else{ // disco azul
    ctx.fillStyle='#4c6dff';
    ctx.beginPath(); ctx.arc(e.x+e.width/2, e.y+e.height/2, e.width/2, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b0b0c';
    ctx.beginPath(); ctx.arc(e.x+e.width/2, e.y+e.height/2, e.width/4, 0, Math.PI*2); ctx.fill();
  }
}

function draw(){
  ctx.clearRect(0,0,gameArea.clientWidth,gameArea.clientHeight);

  // guía sutil arriba
  formation.forEach(e=>{
    if(e.alive){
      ctx.fillStyle = 'rgba(255,255,255,.06)';
      ctx.beginPath(); ctx.arc(e.x, e.y, 10, 0, Math.PI*2); ctx.fill();
    }
  });

  enemies.forEach(drawEnemyShape);

  // jefe
  bosses.forEach(b=>{
    ctx.fillStyle='#c500ff'; ctx.fillRect(b.x,b.y,b.width,b.height);
    ctx.fillStyle='#000';
    ctx.fillRect(b.x+12,b.y+12,b.width-24,12);
    ctx.fillRect(b.x+26,b.y+34,b.width-52,12);
    ctx.fillRect(b.x+38,b.y+56,b.width-76,12);
  });

  // jugador
  if(player.invulnerable===0 || Math.floor(Date.now()/120)%2===0){
    ctx.fillStyle = '#ffff58';
    ctx.beginPath();
    ctx.moveTo(player.x+player.width/2, player.y);
    ctx.lineTo(player.x+player.width,   player.y+player.height);
    ctx.lineTo(player.x,                player.y+player.height);
    ctx.closePath(); ctx.fill();

    if(player.hasShield){
      ctx.strokeStyle='#00eaff'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(player.x+player.width/2, player.y+player.height/2, player.width/2+6, 0, Math.PI*2); ctx.stroke();
    }
  }

  bullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.fillRect(b.x,b.y,b.width,b.height); });
  enemyBullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.fillRect(b.x,b.y,b.width,b.height); });

  powerUps.forEach(p=>{
    ctx.save(); ctx.translate(p.x+p.width/2,p.y+p.height/2);
    if(p.type==='shield'){ ctx.strokeStyle='#00eaff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.stroke(); }
    else if(p.type==='double'){ ctx.fillStyle:'#ffe24a'; ctx.fillRect(-9,-9,6,18); ctx.fillRect(3,-9,6,18); }
    else if(p.type==='bomb'){ ctx.fillStyle='#2ee66f'; ctx.beginPath(); ctx.arc(0,2,9,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#0e5a2b'; ctx.fillRect(-2,-8,4,6); }
    else{ ctx.fillStyle:'#ff4d6d'; ctx.beginPath(); ctx.moveTo(0,8); ctx.bezierCurveTo(12,-6,-12,-6,0,8); ctx.fill(); }
    ctx.restore();
  });

  explosions.forEach(ex=>{
    const alpha = ex.life/ex.maxLife;
    const size  = ex.size*(1 - ex.life/ex.maxLife);
    ctx.fillStyle=`rgba(255,255,0,${alpha})`; ctx.beginPath(); ctx.arc(ex.x,ex.y,size,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=`rgba(255,165,0,${alpha})`; ctx.beginPath(); ctx.arc(ex.x,ex.y,size*.7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=`rgba(255,0,0,${alpha})`;   ctx.beginPath(); ctx.arc(ex.x,ex.y,size*.4,0,Math.PI*2); ctx.fill();
  });

  if(gamePaused){
    ctx.fillStyle='rgba(0,0,0,.8)'; ctx.fillRect(0,0,gameArea.clientWidth,gameArea.clientHeight);
    ctx.fillStyle='#ffa500'; ctx.font='bold 24px Arial'; ctx.textAlign='center';
    ctx.fillText('JUEGO EN PAUSA', gameArea.clientWidth/2, gameArea.clientHeight/2);
  }
}

/* ===== Acciones ===== */
function startGame(){
  if(gameRunning) return;
  gameRunning=true; gamePaused=false; lastTs=0;
  initGame();
  spawnWave(6);      // ¡oleada garantizada!
  requestAnimationFrame(gameLoop);
}
function togglePause(){
  if(!gameRunning) return;
  gamePaused = !gamePaused;
  document.getElementById('pauseButton').innerHTML = gamePaused
    ? '<i class="fa-solid fa-play"></i> Reanudar'
    : '<i class="fa-solid fa-pause"></i> Pausar';
  updateHUD();
  if(!gamePaused) requestAnimationFrame(gameLoop);
}
function gameOver(){
  gameRunning=false; cancelAnimationFrame(animId);
  if(score>highScore){ highScore=score; localStorage.setItem('galagaHighScore', highScore); }
  finalScoreEl.textContent = `Puntuación final: ${score}`;
  gameOverEl.style.display='grid';
}
function restartGame(){ gameOverEl.style.display='none'; startGame(); }

/* ===== Disparo ===== */
function fireBullet(){
  if(!gameRunning || gamePaused) return;
  if(player.doubleShot){
    bullets.push({x:player.x+7, y:player.y, width:4, height:16, speed:8, color:'#7ff4ff'});
    bullets.push({x:player.x+player.width-11, y:player.y, width:4, height:16, speed:8, color:'#7ff4ff'});
  }else{
    bullets.push({x:player.x+player.width/2-2, y:player.y, width:4, height:16, speed:8, color:'#fff36b'});
  }
}
function useSpecial(){
  if(!gameRunning || gamePaused || player.bombs<=0) return;
  player.bombs--;
  enemies.forEach(e=>{ explode(e.x+e.width/2, e.y+e.height/2); score+=50; });
  enemies=[]; explode(gameArea.clientWidth/2, gameArea.clientHeight/2, 120);
  updateHUD();
}

/* ===== Controles ===== */
const moveLeft  = document.getElementById('moveLeft');
const moveRight = document.getElementById('moveRight');
const moveUp    = document.getElementById('moveUp');
const moveDown  = document.getElementById('moveDown');
const fireBtn   = document.getElementById('fireBtn');
const startBtn  = document.getElementById('startButton');
const pauseBtn  = document.getElementById('pauseButton');
const restartBtn= document.getElementById('restartButton');

function hold(btn, prop){
  const on = ()=>{controls[prop]=true}, off=()=>{controls[prop]=false};
  btn.addEventListener('touchstart', on, {passive:true});
  btn.addEventListener('touchend', off);
  btn.addEventListener('mousedown', on);
  btn.addEventListener('mouseup', off);
  btn.addEventListener('mouseleave', off);
}
hold(moveLeft,'left'); hold(moveRight,'right'); hold(moveUp,'up'); hold(moveDown,'down');

fireBtn.addEventListener('touchstart', fireBullet, {passive:true});
fireBtn.addEventListener('mousedown', fireBullet);
document.getElementById('specialBtn').addEventListener('touchstart', useSpecial, {passive:true});
document.getElementById('specialBtn').addEventListener('mousedown', useSpecial);

startBtn.addEventListener('click', startGame);
pauseBtn.addEventListener('click', togglePause);
restartBtn.addEventListener('click', restartGame);

/* Bloqueos extra iOS */
document.addEventListener('contextmenu', e=> e.preventDefault());
document.addEventListener('selectstart', e=> { if(e.target.closest('button')) e.preventDefault(); });
document.addEventListener('gesturestart', e=> e.preventDefault());

/* Boot */
window.addEventListener('load', ()=>{ createStars(); sizeCanvasTo(gameArea); updateHUD(); });
</script>
</body>
</html>