<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Galactic Defender</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  :root{ --ink:#fff; --accent:#ffa500; --ok:#25d366; --danger:#ff4d4d; }

  /* Reset + anti iOS copy/paste */
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{background:#000;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  body{
    min-height:100dvh;
    background:linear-gradient(180deg,#0c0032,#190061,#240090);
    padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
  }

  .page{width:min(960px,100%);margin:auto;padding:12px;display:flex;flex-direction:column;gap:12px}

  /* Topbar */
  .topbar{
    position:sticky;top:0;z-index:20;padding:8px max(10px,env(safe-area-inset-left));
    padding-right:max(10px,env(safe-area-inset-right));
    background:linear-gradient(180deg,rgba(0,0,0,.86),rgba(0,0,0,.45));
    backdrop-filter:saturate(1.2) blur(8px);
    border-bottom:1px solid rgba(255,165,0,.25);
    display:flex;align-items:center;gap:10px
  }
  .back{
    appearance:none;border:1px solid var(--accent);color:#000;
    background:linear-gradient(135deg,#ffd04a,#ff9f1c);
    border-radius:10px;padding:8px 12px;font-weight:800;display:flex;gap:8px;align-items:center;
    touch-action:none; /* que no se lo coma el scroll */
  }
  .spacer{flex:1}

  h1{
    font-size:1.8rem;text-align:center;
    background:linear-gradient(45deg,#ff6b6b,#ffa500,#ffff00);
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    text-shadow:0 0 18px var(--accent)
  }
  .subtitle{text-align:center;color:var(--accent);margin-bottom:6px}

  .stats{
    display:grid;grid-template-columns:repeat(4,1fr);gap:6px;
    background:rgba(0,0,0,.7);border:1px solid var(--accent);
    border-radius:10px;padding:6px;text-align:center
  }
  .stat-label{font-size:.8rem;color:var(--accent)}
  .stat-value{font-weight:800;color:#ffff00}

  .boss-health{width:100%;height:10px;background:#333;border-radius:6px;overflow:hidden;display:none}
  .boss-health-bar{height:100%;background:linear-gradient(90deg,#ff0000,#ffff00);width:100%;transition:width .25s}

  .powerbar{display:flex;gap:10px;align-items:center;justify-content:center}
  .pp{
    min-width:56px;height:42px;padding:0 10px;display:flex;align-items:center;justify-content:center;gap:8px;
    border-radius:12px;border:1px solid var(--accent);background:rgba(255,165,0,.14);font-weight:800
  }
  .pp .cnt{color:#ffff00}

  .game-card{border:2px solid var(--accent);border-radius:12px;overflow:hidden;box-shadow:0 0 16px rgba(255,165,0,.3)}
  .game-area{position:relative;width:100%;aspect-ratio:9/13;max-height:70dvh}
  canvas{display:block;width:100%;height:100%}

  .game-over{position:absolute;inset:0;display:none;place-items:center}
  .dialog{background:rgba(0,0,0,.95);border:3px solid var(--accent);border-radius:12px;padding:16px;text-align:center}
  .dialog h2{color:var(--accent)}
  .final-score{color:#ffff00;margin:8px 0 12px}
  .btn{
    appearance:none;border:none;border-radius:10px;background:linear-gradient(135deg,#ffd04a,#ff9f1c);
    color:#000;font-weight:800;padding:10px 14px;display:inline-flex;gap:6px;align-items:center;touch-action:none
  }
  .btn-alt{background:linear-gradient(135deg,#ffff66,#ffaa00)}
  .controls{display:flex;justify-content:space-between;gap:12px;margin-top:8px}

  /* Botones táctiles confiables */
  .move-btn,.action-btn{
    touch-action:none;pointer-events:auto;-webkit-user-select:none;user-select:none
  }
  .move-btn{
    width:56px;height:56px;border-radius:10px;border:2px solid var(--accent);background:rgba(255,165,0,.3);
    color:var(--accent);font-size:1.2rem
  }
  .move-btn:active{background:rgba(255,165,0,.7);color:#000}
  .actions{display:flex;flex-direction:column;gap:10px}
  .action-btn{
    width:70px;height:70px;border-radius:50%;border:2px solid #f55;background:radial-gradient(circle,#f44,#b00);
    color:#fff;font-size:1.4rem
  }
  .special-btn{border-color:var(--ok);background:radial-gradient(circle,var(--ok),#128c4a)}

  /* Estrellas sutiles abajo (decorativo) */
  .stars{position:fixed;inset:auto 0 0 0;height:280px;pointer-events:none;z-index:-1;opacity:.55}
  .star{position:absolute;background:#fff;border-radius:50%;animation:twinkle 3s infinite}
  @keyframes twinkle{0%,100%{opacity:.3}50%{opacity:1}}
</style>
</head>
<body>
  <!-- Volver al panel principal -->
  <div class="topbar">
    <button class="back" onclick="location.href='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver al Arcade</button>
    <div class="spacer"></div>
  </div>

  <main class="page">
    <h1>GALACTIC DEFENDER</h1>
    <p class="subtitle">Inspirado en el clásico Galaga</p>

    <section class="stats">
      <div><div class="stat-label">PUNTUACIÓN</div><div class="stat-value" id="score">0</div></div>
      <div><div class="stat-label">VIDAS</div><div class="stat-value" id="lives">3</div></div>
      <div><div class="stat-label">NIVEL</div><div class="stat-value" id="level">1</div></div>
      <div><div class="stat-label">RÉCORD</div><div class="stat-value" id="highScore">0</div></div>
    </section>

    <div class="boss-health" id="bossHealth"><div class="boss-health-bar" id="bossHealthBar"></div></div>

    <section class="powerbar">
      <div class="pp" title="Doble Disparo"><i class="fa-solid fa-gun"></i><span class="cnt" id="ppDouble">0</span></div>
      <div class="pp" title="Escudo"><i class="fa-solid fa-shield-halved"></i><span class="cnt" id="ppShield">0</span></div>
      <div class="pp" title="Bombas"><i class="fa-solid fa-bomb"></i><span class="cnt" id="ppBomb">0</span></div>
    </section>

    <section class="game-card">
      <div class="game-area" id="gameArea">
        <canvas id="gameCanvas"></canvas>

        <div class="game-over" id="gameOver">
          <div class="dialog">
            <h2>¡GAME OVER!</h2>
            <div class="final-score" id="finalScore">Puntuación: 0</div>
            <button class="btn" id="restartButton"><i class="fa-solid fa-rotate-right"></i> Jugar de nuevo</button>
          </div>
        </div>
      </div>
    </section>

    <section class="controls">
      <div>
        <button class="move-btn" id="moveLeft"><i class="fa-solid fa-arrow-left"></i></button>
        <button class="move-btn" id="moveUp"><i class="fa-solid fa-arrow-up"></i></button>
        <button class="move-btn" id="moveRight"><i class="fa-solid fa-arrow-right"></i></button>
        <button class="move-btn" id="moveDown"><i class="fa-solid fa-arrow-down"></i></button>
      </div>
      <div class="actions">
        <button class="action-btn" id="fireBtn"><i class="fa-solid fa-bullseye"></i></button>
        <button class="action-btn special-btn" id="specialBtn"><i class="fa-solid fa-bomb"></i></button>
      </div>
    </section>

    <section style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button class="btn" id="startButton"><i class="fa-solid fa-play"></i> Iniciar</button>
      <button class="btn btn-alt" id="pauseButton"><i class="fa-solid fa-pause"></i> Pausar</button>
    </section>
  </main>

  <!-- estrellas decorativas -->
  <div class="stars" id="stars"></div>

<script>
/* ===== Estrellas abajo ===== */
(function(){
  const stars = document.getElementById('stars');
  const N = 80;
  for(let i=0;i<N;i++){
    const s=document.createElement('div');s.className='star';
    const size=1+Math.random()*3;
    s.style.width=s.style.height=size+'px';
    s.style.left=(Math.random()*100)+'%';
    s.style.top =(Math.random()*100)+'%';
    s.style.animationDelay=(Math.random()*3)+'s';
    stars.appendChild(s);
  }
})();

/* ===== Canvas con ResizeObserver ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gameArea = document.getElementById('gameArea');
const DPR = Math.max(1, window.devicePixelRatio || 1);

function sizeCanvas(){
  const r = gameArea.getBoundingClientRect();
  canvas.style.width = r.width+'px';
  canvas.style.height= r.height+'px';
  canvas.width  = Math.floor(r.width * DPR);
  canvas.height = Math.floor(r.height* DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw(); // refresco visual
}
new ResizeObserver(sizeCanvas).observe(gameArea);

/* ===== HUD / Estado ===== */
const scoreEl=document.getElementById('score');
const livesEl=document.getElementById('lives');
const levelEl=document.getElementById('level');
const highEl =document.getElementById('highScore');
const gameOverEl=document.getElementById('gameOver');
const finalScoreEl=document.getElementById('finalScore');
const bossHealth=document.getElementById('bossHealth');
const bossHealthBar=document.getElementById('bossHealthBar');
const ppDouble=document.getElementById('ppDouble');
const ppShield=document.getElementById('ppShield');
const ppBomb  =document.getElementById('ppBomb');
const specialBtn=document.getElementById('specialBtn');

let score=0,lives=3,level=1,highScore=+localStorage.getItem('galagaHighScore')||0;
let gameRunning=false,gamePaused=false,animId,bossActive=false,lastTs=0;

/* Jugador + entidades */
const player={x:0,y:0,w:34,h:38,s:7,inv:0,shield:false,double:false,bombs:0};
let bullets=[],enemyBullets=[],enemies=[],bosses=[],formation=[],powerUps=[],explosions=[];
let doubleT=0,shieldT=0;

/* Util */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const AABB=(a,b)=>a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
function HUD(){
  scoreEl.textContent=score; livesEl.textContent=lives; levelEl.textContent=level; highEl.textContent=highScore;
  ppDouble.textContent=player.double?'ON':'0';
  ppShield.textContent=player.shield?Math.ceil(shieldT/60):'0';
  ppBomb.textContent  =player.bombs;
  specialBtn.disabled = player.bombs<=0 || !gameRunning || gamePaused;
}

/* Formación guía arriba */
function buildFormation(){
  formation=[];
  const marginX=36, marginY=26, areaW=gameArea.clientWidth - marginX*2;
  const maxCols=Math.min(8, Math.floor(areaW/90));
  const cols=Math.max(5,maxCols), rows=Math.min(4,3+Math.min(level-1,1));
  const sx=areaW/cols, sy=64;
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    formation.push({x:marginX+c*sx+sx*0.5,y:marginY+r*sy,alive:true,type:r===0?'bee':r===1?'butterfly':'galaga'});
  }
}

/* Init */
function init(){
  player.x=gameArea.clientWidth/2 - player.w/2;
  player.y=gameArea.clientHeight - player.h - 16;
  Object.assign(player,{inv:0,shield:false,double:false,bombs:0});
  bullets=[];enemyBullets=[];enemies=[];bosses=[];powerUps=[];explosions=[];
  buildFormation(); bossHealth.style.display='none'; bossActive=false;
  score=0;lives=3;level=1; HUD();
}

/* Spawner con cronómetro + oleadas */
let spawnClock=0, spawnEvery=900;
function spawnWave(n=6){
  const alive=formation.filter(f=>f.alive);
  for(let i=0;i<n;i++){
    if(!alive.length)break;
    const pick=alive[(Math.random()*alive.length)|0];
    enemies.push({x:pick.x-16,y:-40,w:32,h:32,s:0.9+level*0.18,t:0,type:pick.type});
  }
}
function maybeSpawn(dt){
  spawnClock+=dt;
  if(spawnClock>=spawnEvery){
    spawnClock=0;
    if(enemies.length < 4 + Math.floor(level*0.7)){
      spawnWave(Math.random()<0.35?2:1);
    }
  }
}

/* Disparos enemigos */
function enemyShoot(){
  if(enemies.length && Math.random()<0.012){
    const e=enemies[(Math.random()*enemies.length)|0];
    enemyBullets.push({x:e.x+e.w/2-2,y:e.y+e.h,w:4,h:12,s:3.1,color:'#ff6b6b'});
  }
}

/* Jefe */
function spawnBoss(){
  if(level%3===0 && !bossActive && enemies.length===0){
    bosses.push({x:gameArea.clientWidth/2-70,y:-110,w:140,h:86,hp:12+level*2,max:12+level*2,t:0});
    bossActive=true; bossHealth.style.display='block'; bossHealthBar.style.width='100%';
  }
}
function bossHUD(b){ bossHealthBar.style.width=(b.hp/b.max*100)+'%'; }

/* FX / Powerups */
function boom(x,y,sz=30){explosions.push({x,y,sz,life:1})}
function drop(x,y){
  if(Math.random()<0.35){
    const bag=['shield','double','bomb','life'];
    const type=bag[(Math.random()*bag.length)|0];
    powerUps.push({x:x-10,y:y-10,w:22,h:22,s:2.1,type});
  }
}

/* UPDATE */
const controls={left:false,right:false,up:false,down:false};
function update(dt){
  // jugador (mitad inferior)
  if(controls.left)  player.x=clamp(player.x - player.s, 0, gameArea.clientWidth-player.w);
  if(controls.right) player.x=clamp(player.x + player.s, 0, gameArea.clientWidth-player.w);
  if(controls.up)    player.y=clamp(player.y - player.s, gameArea.clientHeight*0.5, gameArea.clientHeight-player.h);
  if(controls.down)  player.y=clamp(player.y + player.s, gameArea.clientHeight*0.5, gameArea.clientHeight-player.h);

  if(player.double && --doubleT<=0) player.double=false;
  if(player.shield && --shieldT<=0) player.shield=false;
  if(player.inv>0) player.inv--;

  maybeSpawn(dt); enemyShoot(); spawnBoss();

  // balas jugador
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y-=b.s; if(b.y<-b.h) bullets.splice(i,1);
  }
  // balas enemigo
  for(let i=enemyBullets.length-1;i>=0;i--){
    const b=enemyBullets[i]; b.y+=b.s;
    if(b.y>gameArea.clientHeight){ enemyBullets.splice(i,1); continue; }
    if(AABB({x:b.x,y:b.y,w:b.w,h:b.h}, player) && !player.shield && player.inv===0){
      lives--; player.inv=60; enemyBullets.splice(i,1); HUD(); boom(player.x+player.w/2,player.y+player.h/2);
      if(lives<=0) return gameOver();
    }
  }
  // enemigos
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i]; e.t+=0.07; e.x+=Math.sin(e.t*1.2)*1.5; e.y+=e.s;
    if(e.y>gameArea.clientHeight+60){ enemies.splice(i,1); continue; }
    // impacto
    for(let j=bullets.length-1;j>=0;j--){
      const p=bullets[j];
      if(AABB({x:p.x,y:p.y,w:p.w,h:p.h}, e)){
        boom(e.x+e.w/2,e.y+e.h/2); drop(e.x+e.w/2,e.y+e.h/2);
        score += e.type==='bee'?100 : e.type==='butterfly'?150 : 220;
        enemies.splice(i,1); bullets.splice(j,1); HUD(); break;
      }
    }
    if(AABB(player,e) && !player.shield && player.inv===0){
      lives--; player.inv=60; enemies.splice(i,1); HUD(); boom(player.x+player.w/2,player.y+player.h/2);
      if(lives<=0) return gameOver();
    }
  }
  // jefe
  for(let i=bosses.length-1;i>=0;i--){
    const b=bosses[i]; b.t+=0.035;
    b.x=gameArea.clientWidth/2 - b.w/2 + Math.sin(b.t)*120;
    b.y=50 + Math.cos(b.t*0.6)*26;
    if(Math.random()<0.045){
      for(let k=0;k<3;k++) enemyBullets.push({x:b.x+b.w/2-2+(k-1)*22,y:b.y+b.h,w:6,h:15,s:3.6,color:'#ff00ff'});
    }
    for(let j=bullets.length-1;j>=0;j--){
      const p=bullets[j];
      if(AABB({x:p.x,y:p.y,w:p.w,h:p.h}, b)){
        b.hp--; bullets.splice(j,1); bossHUD(b); boom(p.x,p.y,20);
        if(b.hp<=0){ boom(b.x+b.w/2,b.y+b.h/2,160); score+=1200; bosses.splice(i,1); bossActive=false; bossHealth.style.display='none'; HUD(); }
        break;
      }
    }
  }
  // powerups
  for(let i=powerUps.length-1;i>=0;i--){
    const p=powerUps[i]; p.y+=p.s;
    if(p.y>gameArea.clientHeight){ powerUps.splice(i,1); continue; }
    if(AABB(player,p)){
      if(p.type==='shield'){ player.shield=true; shieldT=360; }
      else if(p.type==='double'){ player.double=true; doubleT=360; }
      else if(p.type==='bomb'){ player.bombs=Math.min(player.bombs+1,9); }
      else { lives++; }
      powerUps.splice(i,1); HUD();
    }
  }
  // explosiones
  for(let i=explosions.length-1;i>=0;i--){
    const e=explosions[i]; e.life-=0.05; if(e.life<=0) explosions.splice(i,1);
  }

  // subir de nivel
  if(!formation.some(f=>f.alive) && enemies.length===0 && bosses.length===0){
    level++; buildFormation(); HUD(); spawnWave(6);
  }
}

/* DRAW */
function drawEnemy(e){
  if(e.type==='bee'){ // triángulo rojo
    ctx.fillStyle='#ff5252';
    ctx.beginPath();
    ctx.moveTo(e.x+e.w/2, e.y);
    ctx.lineTo(e.x+e.w,   e.y+e.h);
    ctx.lineTo(e.x,       e.y+e.h);
    ctx.closePath(); ctx.fill();
  }else if(e.type==='butterfly'){ // rombo verde
    ctx.fillStyle='#45f16f';
    ctx.save(); ctx.translate(e.x+e.w/2, e.y+e.h/2); ctx.rotate(Math.PI/4);
    ctx.fillRect(-e.w/2+2,-e.h/2+2,e.w-4,e.h-4); ctx.restore();
  }else{ // disco azul
    ctx.fillStyle='#4c6dff';
    ctx.beginPath(); ctx.arc(e.x+e.w/2, e.y+e.h/2, e.w/2, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b0b0c';
    ctx.beginPath(); ctx.arc(e.x+e.w/2, e.y+e.h/2, e.w/4, 0, Math.PI*2); ctx.fill();
  }
}
function draw(){
  ctx.clearRect(0,0,gameArea.clientWidth,gameArea.clientHeight);

  // guía sutil arriba
  formation.forEach(f=>{
    if(f.alive){
      ctx.fillStyle='rgba(255,255,255,.06)';
      ctx.beginPath(); ctx.arc(f.x,f.y,10,0,Math.PI*2); ctx.fill();
    }
  });

  enemies.forEach(drawEnemy);

  // jefe
  bosses.forEach(b=>{
    ctx.fillStyle='#c500ff'; ctx.fillRect(b.x,b.y,b.w,b.h);
    ctx.fillStyle='#000';
    ctx.fillRect(b.x+12,b.y+12,b.w-24,12);
    ctx.fillRect(b.x+26,b.y+34,b.w-52,12);
    ctx.fillRect(b.x+38,b.y+56,b.w-76,12);
  });

  // jugador
  if(player.inv===0 || Math.floor(Date.now()/120)%2===0){
    ctx.fillStyle='#ffff58';
    ctx.beginPath();
    ctx.moveTo(player.x+player.w/2, player.y);
    ctx.lineTo(player.x+player.w,   player.y+player.h);
    ctx.lineTo(player.x,            player.y+player.h);
    ctx.closePath(); ctx.fill();

    if(player.shield){
      ctx.strokeStyle='#00eaff'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.arc(player.x+player.w/2, player.y+player.h/2, player.w/2+6, 0, Math.PI*2); ctx.stroke();
    }
  }

  // balas
  bullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.fillRect(b.x,b.y,b.w,b.h); });
  enemyBullets.forEach(b=>{ ctx.fillStyle=b.color; ctx.fillRect(b.x,b.y,b.w,b.h); });

  // powerups
  powerUps.forEach(p=>{
    ctx.save(); ctx.translate(p.x+p.w/2,p.y+p.h/2);
    if(p.type==='shield'){ ctx.strokeStyle='#00eaff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.stroke(); }
    else if(p.type==='double'){ ctx.fillStyle='#ffe24a'; ctx.fillRect(-9,-9,6,18); ctx.fillRect(3,-9,6,18); }
    else if(p.type==='bomb'){ ctx.fillStyle='#2ee66f'; ctx.beginPath(); ctx.arc(0,2,9,0,Math.PI*2); ctx.fill(); ctx.fillStyle:'#0e5a2b'; ctx.fillRect(-2,-8,4,6); }
    else{ ctx.fillStyle='#ff4d6d'; ctx.beginPath(); ctx.moveTo(0,8); ctx.bezierCurveTo(12,-6,-12,-6,0,8); ctx.fill(); }
    ctx.restore();
  });

  // explosiones
  explosions.forEach(ex=>{
    const alpha=ex.life, size=ex.sz*(1-ex.life);
    ctx.fillStyle=`rgba(255,255,0,${alpha})`; ctx.beginPath(); ctx.arc(ex.x,ex.y,size,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=`rgba(255,165,0,${alpha})`; ctx.beginPath(); ctx.arc(ex.x,ex.y,size*.7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=`rgba(255,0,0,${alpha})`;   ctx.beginPath(); ctx.arc(ex.x,ex.y,size*.4,0,Math.PI*2); ctx.fill();
  });

  if(gamePaused){
    ctx.fillStyle='rgba(0,0,0,.8)'; ctx.fillRect(0,0,gameArea.clientWidth,gameArea.clientHeight);
    ctx.fillStyle='#ffa500'; ctx.font='bold 24px Arial'; ctx.textAlign='center';
    ctx.fillText('JUEGO EN PAUSA', gameArea.clientWidth/2, gameArea.clientHeight/2);
  }
}

/* LOOP */
function tick(ts){
  if(!gameRunning || gamePaused) return;
  if(!lastTs) lastTs=ts;
  const dt=ts-lastTs; lastTs=ts;
  update(dt);
  draw();
  animId=requestAnimationFrame(tick);
}

/* Acciones */
function startGame(){
  // Evita estados raros si ya estaba corriendo/pausado
  cancelAnimationFrame(animId);
  lastTs=0;
  init();
  gameRunning=true; gamePaused=false;
  spawnWave(6);             // acción inmediata
  requestAnimationFrame(tick);
}
function togglePause(){
  if(!gameRunning) return;
  gamePaused=!gamePaused;
  document.getElementById('pauseButton').innerHTML = gamePaused
    ? '<i class="fa-solid fa-play"></i> Reanudar'
    : '<i class="fa-solid fa-pause"></i> Pausar';
  HUD();
  if(!gamePaused) requestAnimationFrame(tick);
}
function gameOver(){
  gameRunning=false; cancelAnimationFrame(animId);
  if(score>highScore){ highScore=score; localStorage.setItem('galagaHighScore',highScore); }
  finalScoreEl.textContent=`Puntuación final: ${score}`;
  gameOverEl.style.display='grid';
}
function restartGame(){ gameOverEl.style.display='none'; startGame(); }

/* Disparo jugador */
function fire(){
  if(!gameRunning || gamePaused) return;
  if(player.double){
    bullets.push({x:player.x+7,y:player.y,w:4,h:16,s:8,color:'#7ff4ff'});
    bullets.push({x:player.x+player.w-11,y:player.y,w:4,h:16,s:8,color:'#7ff4ff'});
  }else{
    bullets.push({x:player.x+player.w/2-2,y:player.y,w:4,h:16,s:8,color:'#fff36b'});
  }
}
/* Bomba */
function useBomb(){
  if(!gameRunning || gamePaused || player.bombs<=0) return;
  player.bombs--;
  enemies.forEach(e=>{ boom(e.x+e.w/2, e.y+e.h/2); score+=50; });
  enemies=[]; boom(gameArea.clientWidth/2, gameArea.clientHeight/2, 120);
  HUD();
}

/* Controles: POINTER EVENTS (tacto confiable) */
function bindHold(el, set){
  el.addEventListener('pointerdown', ()=>set(true));
  el.addEventListener('pointerup',   ()=>set(false));
  el.addEventListener('pointerleave',()=>set(false));
  el.addEventListener('lostpointercapture',()=>set(false));
  el.addEventListener('pointercancel',()=>set(false));
  el.addEventListener('contextmenu', e=>e.preventDefault());
  el.addEventListener('selectstart', e=>e.preventDefault());
}

bindHold(document.getElementById('moveLeft'),  v=>controls.left=v);
bindHold(document.getElementById('moveRight'), v=>controls.right=v);
bindHold(document.getElementById('moveUp'),    v=>controls.up=v);
bindHold(document.getElementById('moveDown'),  v=>controls.down=v);

document.getElementById('fireBtn').addEventListener('pointerdown', fire);
document.getElementById('specialBtn').addEventListener('pointerdown', useBomb);

document.getElementById('startButton').addEventListener('click', startGame);
document.getElementById('pauseButton').addEventListener('click', togglePause);
document.getElementById('restartButton').addEventListener('click', restartGame);

/* Bloqueos extra iOS */
document.addEventListener('gesturestart', e=>e.preventDefault());
document.addEventListener('contextmenu', e=>e.preventDefault());

/* Boot */
window.addEventListener('load', ()=>{ sizeCanvas(); HUD(); });
</script>
</body>
</html>