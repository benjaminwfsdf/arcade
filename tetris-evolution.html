<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Tetris Evolution</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  :root{
    --ink:#fff; --c1:#00ffff; --c2:#0080ff; --c3:#a000ff; --glow:rgba(0,255,255,.4);
    --btn:72px;  /* ← cambia este valor para agrandar/achicar flechas */
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:manipulation}
  html,body{height:100%;background:#0a0a1a;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  body{overflow:auto;display:flex;flex-direction:column;align-items:center;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)}
  .container{width:100%;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:12px}
  .header{text-align:center}
  h1{font-size:2.4rem;letter-spacing:3px;margin-bottom:6px;background:linear-gradient(45deg,#00ffff,#0080ff,#a000ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 22px var(--glow)}
  .subtitle{font-size:.95rem;color:#66ccff}
  .game-container{display:flex;width:100%;gap:14px;justify-content:center;align-items:flex-start;flex:1;padding:8px}
  .main-game{display:flex;flex-direction:column;align-items:center;gap:10px;min-width:220px}
  .game-board{border:3px solid var(--c1);border-radius:12px;background:rgba(0,0,0,.85);box-shadow:0 0 28px var(--glow);overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:260px}
  canvas{display:block}
  .level-progress{width:100%;max-width:380px;height:10px;background:rgba(255,255,255,.12);border-radius:6px;overflow:hidden}
  .level-bar{height:100%;background:linear-gradient(90deg,#00ffff,#0080ff);width:0%}
  .side-panel{display:flex;flex-direction:column;gap:12px;min-width:120px}
  .info-panel{background:rgba(0,0,0,.7);border:2px solid var(--c1);border-radius:10px;padding:12px;box-shadow:0 0 18px rgba(0,255,255,.2)}
  .panel-title{font-size:.9rem;color:#00ffff;margin-bottom:8px;text-align:center;font-weight:700}
  .stat{margin-bottom:8px}
  .stat-label{font-size:.78rem;color:#66ccff}
  .stat-value{font-size:1.2rem;font-weight:800;text-shadow:0 0 10px #00ffff}
  .mini{background:rgba(0,0,0,.45);border:2px solid #00ffff;border-radius:8px;padding:8px;text-align:center}
  .controls{width:100%;display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .movement-controls{
    display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(3,1fr);
    gap:10px;margin:0 auto;max-width:420px
  }
  .control-btn{
    width:var(--btn); height:var(--btn);
    background:linear-gradient(135deg,#1088ff,#00b0ff);border:none;border-radius:14px;
    color:#fff;font-size:1.35rem;font-weight:900;display:flex;align-items:center;justify-content:center;
    box-shadow:0 6px 18px rgba(0,128,255,.4)
  }
  .control-btn:active{transform:scale(.94)}
  .btn-rotate{grid-column:5;grid-row:1;background:linear-gradient(135deg,#ff00ff,#cc00ff)}
  .btn-left{grid-column:1;grid-row:2}
  .btn-down{grid-column:2;grid-row:2}
  .btn-right{grid-column:3;grid-row:2}
  .btn-hard-drop{grid-column:4;grid-row:2;background:linear-gradient(135deg,#ffff00,#ffaa00)}
  .btn-hold{grid-column:5;grid-row:2;background:linear-gradient(135deg,#00ff80,#00cc66)}
  .action-buttons{display:flex;gap:10px;justify-content:center;margin-top:6px}
  .action-btn{flex:1;background:linear-gradient(135deg,#00ffff,#0080ff);border:none;border-radius:12px;color:#000;padding:12px 10px;font-size:.95rem;font-weight:900;display:flex;align-items:center;justify-content:center;gap:6px;max-width:170px;box-shadow:0 6px 18px rgba(0,255,255,.4)}
  .btn-pause{background:linear-gradient(135deg,#ffff00,#ffaa00)}
  .game-over{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.9);z-index:50}
  .game-over .panel{background:rgba(0,0,0,.92);padding:22px;border-radius:18px;border:3px solid #00ffff;width:min(92%,360px);text-align:center;box-shadow:0 0 36px var(--glow)}
  .game-over h2{font-size:1.8rem;margin-bottom:10px;color:#00ffff}
  .final-stat{margin:8px 0;color:#66ccff}
  .combo-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.7);font-size:2.6rem;font-weight:900;color:#ffff00;text-shadow:0 0 16px #ffff00;opacity:0;transition:all .25s;pointer-events:none}
  /* Botón pequeño de Volver arriba-izquierda */
  .back-fab{
    position:fixed; left:12px; top:calc(12px + env(safe-area-inset-top,0px));
    width:44px; height:44px; border-radius:999px; z-index:60;
    display:grid; place-items:center; color:#012; text-decoration:none;
    background:linear-gradient(180deg,#aef,#4df); border:2px solid #6df; box-shadow:0 8px 18px rgba(0,0,0,.32)
  }
  .back-fab i{font-size:18px}
  @media (max-height:740px){
    .game-container{flex-direction:column;align-items:center}
    .side-panel{flex-direction:row;gap:10px;justify-content:center}
  }
</style>
</head>
<body>
  <a class="back-fab" href="index.html" aria-label="Volver"><i class="fas fa-arrow-left"></i></a>

  <div class="container" id="wrap">
    <div class="header">
      <h1>TETRIS EVOLUTION</h1>
      <p class="subtitle">El clásico reinventado para móvil</p>
    </div>

    <div class="game-container">
      <div class="main-game">
        <div class="game-board" id="boardWrap">
          <canvas id="gameCanvas" width="300" height="600"></canvas>
        </div>
        <div class="level-progress"><div class="level-bar" id="levelBar"></div></div>
      </div>

      <div class="side-panel">
        <div class="info-panel">
          <div class="panel-title">ESTADÍSTICAS</div>
          <div class="stat"><div class="stat-label">PUNTUACIÓN</div><div class="stat-value" id="score">0</div></div>
          <div class="stat"><div class="stat-label">LÍNEAS</div><div class="stat-value" id="lines">0</div></div>
          <div class="stat"><div class="stat-label">NIVEL</div><div class="stat-value" id="level">1</div></div>
          <div class="stat"><div class="stat-label">RÉCORD</div><div class="stat-value" id="highScore">0</div></div>
        </div>

        <div class="mini">
          <div class="panel-title">SIGUIENTE</div>
          <canvas id="nextCanvas" width="96" height="96"></canvas>
        </div>

        <div class="mini">
          <div class="panel-title">RESERVA</div>
          <canvas id="holdCanvas" width="96" height="96"></canvas>
        </div>
      </div>
    </div>

    <div class="controls" id="controls">
      <div class="movement-controls">
        <button class="control-btn btn-rotate" id="rotateBtn" aria-label="Rotar"><i class="fas fa-redo-alt"></i></button>
        <button class="control-btn btn-left"   id="leftBtn"   aria-label="Izquierda"><i class="fas fa-arrow-left"></i></button>
        <button class="control-btn btn-down"   id="downBtn"   aria-label="Abajo"><i class="fas fa-arrow-down"></i></button>
        <button class="control-btn btn-right"  id="rightBtn"  aria-label="Derecha"><i class="fas fa-arrow-right"></i></button>
        <button class="control-btn btn-hard-drop" id="hardDropBtn" aria-label="Caída fuerte"><i class="fas fa-arrow-down"></i></button>
        <button class="control-btn btn-hold"   id="holdBtn"   aria-label="Reservar"><i class="fas fa-exchange-alt"></i></button>
      </div>
      <div class="action-buttons">
        <button class="action-btn" id="startButton"><i class="fas fa-play"></i> INICIAR</button>
        <button class="action-btn btn-pause" id="pauseButton"><i class="fas fa-pause"></i> PAUSAR</button>
      </div>
    </div>

    <div class="combo-display" id="comboDisplay"></div>

    <div class="game-over" id="gameOver">
      <div class="panel">
        <h2>¡GAME OVER!</h2>
        <div class="final-stat">Puntuación: <span id="finalScore">0</span></div>
        <div class="final-stat">Líneas: <span id="finalLines">0</span></div>
        <div class="final-stat">Nivel: <span id="finalLevel">1</span></div>
        <button class="action-btn" id="restartButton"><i class="fas fa-redo"></i> JUGAR DE NUEVO</button>
      </div>
    </div>
  </div>

<script>
  /* ===== DOM ===== */
  const gameCanvas=document.getElementById('gameCanvas'), gameCtx=gameCanvas.getContext('2d');
  const nextCanvas=document.getElementById('nextCanvas'), nextCtx=nextCanvas.getContext('2d');
  const holdCanvas=document.getElementById('holdCanvas'), holdCtx=holdCanvas.getContext('2d');
  const boardWrap=document.getElementById('boardWrap');
  const scoreElem=document.getElementById('score'), linesElem=document.getElementById('lines'), levelElem=document.getElementById('level'), highScoreElem=document.getElementById('highScore');
  const levelBar=document.getElementById('levelBar'), comboDisplay=document.getElementById('comboDisplay');
  const startButton=document.getElementById('startButton'), pauseButton=document.getElementById('pauseButton'), restartButton=document.getElementById('restartButton');
  const rotateBtn=document.getElementById('rotateBtn'), leftBtn=document.getElementById('leftBtn'), rightBtn=document.getElementById('rightBtn'), downBtn=document.getElementById('downBtn'), hardDropBtn=document.getElementById('hardDropBtn'), holdBtn=document.getElementById('holdBtn');

  /* ===== Config ===== */
  const COLS=10, ROWS=20; let BLOCK=30;
  const COLORS=[null,'#00ffff','#0000ff','#ffa500','#ffff00','#00ff00','#ff00ff','#ff0000'];
  const PIECES=[null,[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[2,0,0],[2,2,2],[0,0,0]],[[0,0,3],[3,3,3],[0,0,0]],[[4,4],[4,4]],[[0,5,5],[5,5,0],[0,0,0]],[[0,6,0],[6,6,6],[0,0,0]],[[7,7,0],[0,7,7],[0,0,0]]];

  /* ===== Estado ===== */
  let board=[]; let score=0, lines=0, level=1, highScore=Number(localStorage.getItem('tetrisHighScore'))||0;
  let gameRunning=false, gamePaused=false, animationId=0;
  let dropCounter=0, dropInterval=1000, lastTime=0;
  let current=null, next=null, hold=null, canHold=true;
  let comboCount=0, lockDelay=0;
  let bag=[];

  function refillBag(){ bag=[1,2,3,4,5,6,7]; for(let i=bag.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [bag[i],bag[j]]=[bag[j],bag[i]]; } }
  function pullFromBag(){ if(!bag.length) refillBag(); return bag.pop(); }

  /* ===== Tablero / Piezas ===== */
  function createBoard(){ board=Array.from({length:ROWS},()=>Array(COLS).fill(0)); }
  function topPad(s){ for(let y=0;y<s.length;y++) if(s[y].some(v=>v)) return y; return 0; }
  function newPiece(id){ const s=JSON.parse(JSON.stringify(PIECES[id])); return {id,shape:s,x:Math.floor(COLS/2)-Math.ceil(s[0].length/2),y:-topPad(s)}; }
  function spawn(){ if(!next) next=newPiece(pullFromBag()); current=next; next=newPiece(pullFromBag()); canHold=true; lockDelay=0; if(collides(0,0,current.shape)) gameOver(); }

  /* ===== Colisiones / Movimiento ===== */
  function collides(dx,dy,shape){
    for(let y=0;y<shape.length;y++) for(let x=0;x<shape[y].length;x++){
      if(!shape[y][x]) continue;
      const nx=current.x+x+dx, ny=current.y+y+dy;
      if(nx<0||nx>=COLS||ny>=ROWS) return true;
      if(ny>=0 && board[ny][nx]) return true;
    }
    return false;
  }
  function move(dx,dy){
    if(!current) return false;
    current.x+=dx; current.y+=dy;
    if(collides(0,0,current.shape)){
      current.x-=dx; current.y-=dy;
      if(dy>0){ lockDelay++; if(lockDelay>=6) place(); }
      return false;
    } else { if(dy>0) lockDelay=0; return true; }
  }
  function rotateCW(){
    if(!current) return;
    const s=current.shape.map(r=>r.slice());
    for(let y=0;y<s.length;y++) for(let x=0;x<y;x++) [s[y][x],s[x][y]]=[s[x][y],s[y][x]];
    s.forEach(r=>r.reverse());
    for(const k of [0,-1,1,-2,2]){ if(!collides(k,0,s)){ current.shape=s; current.x+=k; showCombo("ROTATE!"); return; } }
  }
  function hardDrop(){ if(!current) return; let n=0; while(move(0,1)) n++; score+=n*2; place(); showCombo("HARD DROP!"); }
  function place(){
    const s=current.shape;
    for(let y=0;y<s.length;y++) for(let x=0;x<s[y].length;x++){
      if(!s[y][x]) continue; const ny=current.y+y; if(ny>=0) board[ny][current.x+x]=current.id;
    }
    const c=clearLines(); updateScore(c); spawn();
  }
  function clearLines(){
    let c=0;
    for(let y=ROWS-1;y>=0;y--){
      if(board[y].every(v=>v)){ board.splice(y,1); board.unshift(Array(COLS).fill(0)); c++; y++; }
    }
    if(c){ lines+=c; comboCount++; showCombo(comboText(c)); level=Math.floor(lines/10)+1; dropInterval=Math.max(80,1000-(level-1)*80); }
    else comboCount=0;
    return c;
  }
  function holdAction(){
    if(!canHold||!current) return;
    if(!hold){ hold=current; spawn(); }
    else{ const o=hold; hold=current; current=newPiece(o.id); }
    hold.x=Math.floor(COLS/2)-Math.ceil(hold.shape[0].length/2); hold.y=-topPad(hold.shape);
    canHold=false; showCombo("HOLD!");
  }

  /* ===== HUD ===== */
  function updateScore(c){ const base=[0,100,300,500,800][c]||0, combo=comboCount>1?comboCount*50:0; score+=base*level+combo; updateHUD(); }
  function updateHUD(){ scoreElem.textContent=score; linesElem.textContent=lines; levelElem.textContent=level; highScoreElem.textContent=highScore; levelBar.style.width=((lines%10)*10)+'%'; }
  function comboText(n){ const m={1:["GOOD!","NICE!"],2:["DOUBLE!","GREAT!"],3:["TRIPLE!","AWESOME!"],4:["TETRIS!","PERFECT!"]}; const a=m[n]||["COMBO!"]; return a[(Math.random()*a.length)|0]; }
  function showCombo(t){ comboDisplay.textContent=t; comboDisplay.style.opacity='1'; comboDisplay.style.transform='translate(-50%,-50%) scale(1)'; setTimeout(()=>{ comboDisplay.style.opacity='0'; comboDisplay.style.transform='translate(-50%,-50%) scale(.7)'; },650); }

  /* ===== Dibujo ===== */
  function shade(hex,a){ let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); r=Math.min(255,Math.max(0,r+a)); g=Math.min(255,Math.max(0,g+a)); b=Math.min(255,Math.max(0,b+a)); return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).padStart(7,'#'); }
  function drawBlock(ctx,x,y,id,alpha=1){ const color=COLORS[id]; const g=ctx.createLinearGradient(x*BLOCK,y*BLOCK,(x+1)*BLOCK,(y+1)*BLOCK); g.addColorStop(0,color); g.addColorStop(1,shade(color,-30)); ctx.globalAlpha=alpha; ctx.fillStyle=g; ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK); ctx.strokeStyle=shade(color,50); ctx.lineWidth=2; ctx.strokeRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK); ctx.fillStyle='rgba(255,255,255,.25)'; ctx.fillRect(x*BLOCK+2,y*BLOCK+2,BLOCK-4,4); ctx.globalAlpha=1; }
  function drawBoard(){ gameCtx.fillStyle='#000'; gameCtx.fillRect(0,0,gameCanvas.width,gameCanvas.height); gameCtx.strokeStyle='rgba(255,255,255,.08)'; for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++){ gameCtx.strokeRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK); if(board[y][x]) drawBlock(gameCtx,x,y,board[y][x],1); } }
  function shapeCollides(px,py,shape){ for(let y=0;y<shape.length;y++) for(let x=0;x<shape[y].length;x++){ if(!shape[y][x]) continue; const nx=px+x, ny=py+y; if(nx<0||nx>=COLS||ny>=ROWS) return true; if(ny>=0 && board[ny][nx]) return true; } return false; }
  function ghostY(){ if(!current) return 0; let gy=current.y; while(!shapeCollides(current.x,gy+1,current.shape)) gy++; return gy; }
  function drawGhost(){ if(!current) return; const gy=ghostY(); const s=current.shape; for(let y=0;y<s.length;y++) for(let x=0;x<s[y].length;x++) if(s[y][x]) drawBlock(gameCtx,current.x+x,gy+y,current.id,.25); }
  function drawPiece(){ if(!current) return; const s=current.shape; for(let y=0;y<s.length;y++) for(let x=0;x<s[y].length;x++) if(s[y][x]) drawBlock(gameCtx,current.x+x,current.y+y,current.id,1); }
  function drawMini(ctx,cvs,p){ ctx.clearRect(0,0,cvs.width,cvs.height); if(!p) return; const bs=Math.floor(Math.min(cvs.width,cvs.height)/4); const sh=p.shape,w=sh[0].length,h=sh.length; const ox=Math.floor((cvs.width-w*bs)/2), oy=Math.floor((cvs.height-h*bs)/2); for(let y=0;y<h;y++) for(let x=0;x<w;x++) if(sh[y][x]){ const color=COLORS[p.id]; const g=ctx.createLinearGradient(ox+x*bs,oy+y*bs,ox+(x+1)*bs,oy+(y+1)*bs); g.addColorStop(0,color); g.addColorStop(1,shade(color,-30)); ctx.fillStyle=g; ctx.fillRect(ox+x*bs,oy+y*bs,bs,bs); ctx.strokeStyle=shade(color,50); ctx.lineWidth=2; ctx.strokeRect(ox+x*bs,oy+y*bs,bs,bs); } }
  function drawAll(){ drawBoard(); drawGhost(); drawPiece(); drawMini(nextCtx,nextCanvas,next); drawMini(holdCtx,holdCanvas,hold); }

  /* ===== Loop ===== */
  function loop(t=0){
    if(!gameRunning||gamePaused) return;
    const dt=t-lastTime; lastTime=t;
    dropCounter+=dt;
    if(dropCounter>=dropInterval){ move(0,1); dropCounter=0; }
    drawAll();
    animationId=requestAnimationFrame(loop);
  }

  /* ===== Controles (flecha inicia) ===== */
  let dasTimer=null, arrTimer=null;
  const startRepeat=(fn,das=160,arr=55)=>{ stopRepeat(); fn(); dasTimer=setTimeout(()=>{ arrTimer=setInterval(fn,arr); },das); };
  const stopRepeat=()=>{ clearTimeout(dasTimer); clearInterval(arrTimer); dasTimer=arrTimer=null; };
  const bind=(el,down,up)=>{ el.addEventListener('pointerdown',e=>{ e.preventDefault(); ensureStart(); down(); el.setPointerCapture?.(e.pointerId); }); el.addEventListener('pointerup',()=>up&&up()); el.addEventListener('pointercancel',()=>up&&up()); el.addEventListener('click',()=>down()); };

  function setupControls(){
    bind(leftBtn, ()=>startRepeat(()=>move(-1,0)), stopRepeat);
    bind(rightBtn,()=>startRepeat(()=>move(1,0)),  stopRepeat);
    bind(downBtn, ()=>startRepeat(()=>move(0,1),120,35), stopRepeat);
    bind(rotateBtn, ()=>rotateCW());
    bind(hardDropBtn, ()=>hardDrop());
    bind(holdBtn, ()=>holdAction());

    startButton.addEventListener('click', ()=>{ start(); startButton.blur(); });
    pauseButton.addEventListener('click', ()=>togglePause());
    restartButton.addEventListener('click', ()=>restart());

    const holdKeys={ArrowLeft:()=>startRepeat(()=>move(-1,0)),ArrowRight:()=>startRepeat(()=>move(1,0)),ArrowDown:()=>startRepeat(()=>move(0,1),120,35)};
    const once={ArrowUp:rotateCW,Space:hardDrop,KeyC:holdAction,ShiftLeft:holdAction,ShiftRight:holdAction};
    document.addEventListener('keydown',e=>{ if(e.repeat) return; ensureStart(); if(holdKeys[e.code]){e.preventDefault(); holdKeys[e.code]();} else if(once[e.code]){e.preventDefault(); once[e.code]();} else if(e.code==='KeyP'){e.preventDefault(); togglePause();} });
    document.addEventListener('keyup',e=>{ if(['ArrowLeft','ArrowRight','ArrowDown'].includes(e.code)){ e.preventDefault(); stopRepeat(); } });
  }

  /* ===== Ciclo de vida ===== */
  function init(){ resizeCanvas(); createBoard(); score=0;lines=0;level=1;dropInterval=1000;comboCount=0;lockDelay=0; refillBag(); current=null; next=null; hold=null; canHold=true; updateHUD(); drawAll(); }
  function start(){ if(gameRunning) return; gameRunning=true; gamePaused=false; document.getElementById('gameOver').style.display='none'; spawn(); lastTime=performance.now(); loop(lastTime); }
  function ensureStart(){ if(!gameRunning) start(); }
  function togglePause(){ if(!gameRunning) return; gamePaused=!gamePaused; pauseButton.innerHTML=gamePaused?'<i class="fas fa-play"></i> REANUDAR':'<i class="fas fa-pause"></i> PAUSAR'; if(!gamePaused){ lastTime=performance.now(); loop(lastTime);} }
  function gameOver(){ gameRunning=false; cancelAnimationFrame(animationId); stopRepeat(); if(score>highScore){ highScore=score; localStorage.setItem('tetrisHighScore',String(highScore)); } document.getElementById('finalScore').textContent=score; document.getElementById('finalLines').textContent=lines; document.getElementById('finalLevel').textContent=level; document.getElementById('gameOver').style.display='grid'; }
  function restart(){ document.getElementById('gameOver').style.display='none'; init(); start(); }

  /* ===== Responsive ===== */
  function resizeCanvas(){
    const vh=window.innerHeight;
    const targetH=Math.max(260, Math.floor(vh*(vh<740?0.5:0.64)));
    let w=Math.min(420, Math.floor(targetH/2)); let h=w*2;
    const aw=Math.min(boardWrap.clientWidth||window.innerWidth-24, window.innerWidth-24);
    if(w>aw){ w=Math.floor(aw); h=w*2; }
    gameCanvas.width=w; gameCanvas.height=h; BLOCK=Math.floor(w/COLS); drawAll();
  }
  if(typeof ResizeObserver!=='undefined'){ new ResizeObserver(()=>resizeCanvas()).observe(boardWrap); }
  window.addEventListener('orientationchange', ()=> setTimeout(resizeCanvas,250));
  window.addEventListener('resize', resizeCanvas);

  // === Arranque automático ===
  window.addEventListener('load', ()=>{ init(); setupControls(); start(); });
</script>
</body>
</html>
